"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var rxjs_1 = require("rxjs");
var nativescript_socketio_1 = require("nativescript-socketio");
var nativescript_webrtc_plugin_1 = require("nativescript-webrtc-plugin");
var operators_1 = require("rxjs/operators");
var CallService = /** @class */ (function () {
    function CallService(socket) {
        var _this = this;
        this.socket = socket;
        this.microphoneState = false;
        this.videostat = false;
        this.socket.on('call:iceCandidate', function (data) {
            var sdpMid = data.sdpMid;
            var sdpMLineIndex = data.sdpMLineIndex;
            var sdp = data.sdp;
            if (_this.webrtc) {
                _this.webrtc.addIceCandidate({
                    sdp: sdp,
                    sdpMid: sdpMid,
                    sdpMLineIndex: sdpMLineIndex
                });
            }
        });
        this.socket.on('call:answered', function (data) {
            _this.webrtc.handleAnswerReceived({ sdp: data.sdp, type: data.type });
        });
        this.socket.on('call:answer', function (data) {
            _this.answerCall({
                sdp: data.sdp,
                type: data.type
            }, { enableVideo: true, enableAudio: true });
        });
    }
    CallService.prototype.getUsers = function () {
        this.socket.emit('getUsers', {});
    };
    CallService.prototype.answerCall = function (sdp, options) {
        var _this = this;
        this.webrtc = new nativescript_webrtc_plugin_1.WebRTC(options);
        this.webrtc.on('webRTCClientDidReceiveRemoteVideoTrackStream', function (args) {
            var object = args.object;
            var remoteVideoTrack = object.get('remoteVideoTrack');
            console.log(remoteVideoTrack);
            _this.videoTrack = object.get('remoteVideoTrack');
            _this.remoteStream = object.get('stream');
            var video = _this.remoteVideoView;
            if (video) {
                video.videoTrack = remoteVideoTrack;
            }
        });
        this.webrtc.on('webRTCClientStartCallWithSdp', function (args) {
            var sdp = args.object.get('sdp');
            var type = args.object.get('type');
            if (type === nativescript_webrtc_plugin_1.WebRTCSdpType.ANSWER) {
                _this.socket.emit('answered', {
                    from: _this.currentUser,
                    to: _this.other,
                    sdp: sdp,
                    type: type
                });
            }
        });
        this.webrtc.on('webRTCClientDidGenerateIceCandidate', function (args) {
            var iceCandidate = args.object.get('iceCandidate');
            _this.socket.emit('iceCandidate', Object.assign({ to: _this.other, from: _this.currentUser }, iceCandidate));
        });
        this.initCamera().then(function (stream) {
            _this.localStream = stream;
            _this.setUpLocalView(true);
            _this.webrtc.connect();
            _this.webrtc.addLocalStream(_this.localStream);
            _this.webrtc.createAnswerForOfferReceived({
                type: sdp.type,
                sdp: sdp.sdp
            });
        });
    };
    CallService.prototype.answer = function (from, to, sdp, type) {
        this.other = from;
        this.answerCall({
            sdp: sdp,
            type: type
        }, { enableVideo: true, enableAudio: true });
    };
    CallService.prototype.call = function (username, options) {
        var _this = this;
        this.other = username;
        this.webrtc = new nativescript_webrtc_plugin_1.WebRTC(options);
        this.webrtc.on('webRTCClientDidReceiveRemoteVideoTrackStream', function (args) {
            var object = args.object;
            var remoteVideoTrack = object.get('remoteVideoTrack');
            var video = _this.remoteVideoView;
            console.log(typeof remoteVideoTrack);
            _this.remoteStream = object.get('stream');
            if (video) {
                video.videoTrack = remoteVideoTrack;
            }
        });
        this.webrtc.on('webRTCClientStartCallWithSdp', function (args) {
            var sdp = args.object.get('sdp');
            var type = args.object.get('type');
            if (type === nativescript_webrtc_plugin_1.WebRTCSdpType.ANSWER) {
                _this.webrtc.handleAnswerReceived({
                    sdp: sdp,
                    type: type
                });
            }
            else {
                _this.socket.emit('call', {
                    from: _this.currentUser,
                    to: username,
                    sdp: sdp,
                    type: type
                });
            }
        });
        this.webrtc.on('webRTCClientDidGenerateIceCandidate', function (args) {
            var iceCandidate = args.object.get('iceCandidate');
            _this.socket.emit('iceCandidate', Object.assign({
                to: username,
                from: _this.currentUser
            }, iceCandidate));
        });
        this.initCamera().then(function (stream) {
            _this.localStream = stream;
            _this.setUpLocalView(true);
            _this.webrtc.connect();
            _this.webrtc.addLocalStream(_this.localStream);
            _this.webrtc.makeOffer();
        });
    };
    CallService.prototype.initCamera = function () {
        var _this = this;
        if (nativescript_webrtc_plugin_1.WebRTC.hasPermissions()) {
            return this.webrtc.getUserMedia(1);
        }
        else {
            return rxjs_1.from(nativescript_webrtc_plugin_1.WebRTC.requestPermissions())
                .pipe(operators_1.switchMap(function () {
                if (nativescript_webrtc_plugin_1.WebRTC.hasPermissions()) {
                    return rxjs_1.from(_this.webrtc.getUserMedia(1));
                }
                return rxjs_1.throwError('Has no permission');
            }))
                .toPromise();
        }
    };
    CallService.prototype.setUpLocalView = function (mirror) {
        var localVideo = this.localVideoView;
        localVideo.mirror = true;
        localVideo.stream = this.localStream;
    };
    // Personals functions.
    CallService.prototype.changeMicrophoneState = function () {
        this.microphoneState = !this.microphoneState;
        return this.webrtc.micEnabled(!this.microphoneState);
    };
    CallService.prototype.stopVideo = function () {
        var videoTrack = this.localStream.videoTracks.get(0);
        var trackId = videoTrack.id();
        this.videostat = !this.videostat;
        videoTrack.setEnabled(this.videostat);
    };
    CallService.prototype.stopCall = function () {
        this.webrtc.disconnect();
    };
    CallService = __decorate([
        core_1.Injectable(),
        __metadata("design:paramtypes", [nativescript_socketio_1.SocketIO])
    ], CallService);
    return CallService;
}());
exports.CallService = CallService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FsbC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY2FsbC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsc0NBQTJDO0FBQzNDLDZCQUF3QztBQUN4QywrREFBaUQ7QUFDakQseUVBQWtHO0FBQ2xHLDRDQUEyQztBQUczQztJQWNJLHFCQUFtQixNQUFnQjtRQUFuQyxpQkE0QkM7UUE1QmtCLFdBQU0sR0FBTixNQUFNLENBQVU7UUFMbkMsb0JBQWUsR0FBWSxLQUFLLENBQUM7UUFFakMsY0FBUyxHQUFZLEtBQUssQ0FBQztRQUt2QixJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxtQkFBbUIsRUFBRSxVQUFBLElBQUk7WUFDcEMsSUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztZQUMzQixJQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDO1lBQ3pDLElBQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUM7WUFDckIsSUFBSSxLQUFJLENBQUMsTUFBTSxFQUFFO2dCQUViLEtBQUksQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDO29CQUN4QixHQUFHLEVBQUUsR0FBRztvQkFDUixNQUFNLEVBQUUsTUFBTTtvQkFDZCxhQUFhLEVBQUUsYUFBYTtpQkFDL0IsQ0FBQyxDQUFDO2FBQ047UUFDTCxDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLGVBQWUsRUFBRSxVQUFBLElBQUk7WUFDaEMsS0FBSSxDQUFDLE1BQU0sQ0FBQyxvQkFBb0IsQ0FBQyxFQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFDLENBQUMsQ0FBQztRQUN2RSxDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLGFBQWEsRUFBRSxVQUFBLElBQUk7WUFDOUIsS0FBSSxD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QUFVLENBQUMsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7SUFDekQsQ0FBQztJQUdELCtCQUFTLEdBQVQ7UUFDSSxJQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdkQsSUFBTSxPQUFPLEdBQUcsVUFBVSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ2hDLElBQUksQ0FBQyxTQUFTLEdBQUcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDO1FBQ2pDLFVBQVUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBRTFDLENBQUM7SUFHRCw4QkFBUSxHQUFSO1FBRUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUUsQ0FBQztJQUM3QixDQUFDO0lBck5RLFdBQVc7UUFEdkIsaUJBQVUsRUFBRTt5Q0Fla0IsZ0NBQVE7T0FkMUIsV0FBVyxDQXVOdkI7SUFBRCxrQkFBQztDQUFBLEFBdk5ELElBdU5DO0FBdk5ZLGtDQUFXIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgZnJvbSwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgU29ja2V0SU8gfSBmcm9tICduYXRpdmVzY3JpcHQtc29ja2V0aW8nO1xuaW1wb3J0IHsgV2ViUlRDLCBXZWJSVENJY2VDYW5kaWRhdGUsIFdlYlJUQ1NkcCwgV2ViUlRDU2RwVHlwZSB9IGZyb20gJ25hdGl2ZXNjcmlwdC13ZWJydGMtcGx1Z2luJztcbmltcG9ydCB7IHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIENhbGxTZXJ2aWNlIHtcbiAgICBsb2NhbFN0cmVhbTogYW55O1xuICAgIHJlbW90ZVN0cmVhbTogYW55O1xuICAgIGN1cnJlbnRVc2VyOiBzdHJpbmc7XG4gICAgbG9jYWxWaWRlb1ZpZXc6IGFueTtcbiAgICByZW1vdGVWaWRlb1ZpZXc6IGFueTtcbiAgICB3ZWJydGM6IFdlYlJUQztcbiAgICBvdGhlcjogYW55O1xuICAgIGxvY2FsVmlkZW9UcmFjazogYW55O1xuICAgIG1pY3JvcGhvbmVTdGF0ZTogYm9vbGVhbiA9IGZhbHNlO1xuICAgIHZpZGVvVHJhY2s6IGFueTtcbiAgICB2aWRlb3N0YXQ6IGJvb2xlYW4gPSBmYWxzZTtcblxuXG4gICAgY29uc3RydWN0b3IocHVibGljIHNvY2tldDogU29ja2V0SU8pIHtcblxuICAgICAgICB0aGlzLnNvY2tldC5vbignY2FsbDppY2VDYW5kaWRhdGUnLCBkYXRhID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHNkcE1pZCA9IGRhdGEuc2RwTWlkO1xuICAgICAgICAgICAgY29uc3Qgc2RwTUxpbmVJbmRleCA9IGRhdGEuc2RwTUxpbmVJbmRleDtcbiAgICAgICAgICAgIGNvbnN0IHNkcCA9IGRhdGEuc2RwO1xuICAgICAgICAgICAgaWYgKHRoaXMud2VicnRjKSB7XG5cbiAgICAgICAgICAgICAgICB0aGlzLndlYnJ0Yy5hZGRJY2VDYW5kaWRhdGUoe1xuICAgICAgICAgICAgICAgICAgICBzZHA6IHNkcCxcbiAgICAgICAgICAgICAgICAgICAgc2RwTWlkOiBzZHBNaWQsXG4gICAgICAgICAgICAgICAgICAgIHNkcE1MaW5lSW5kZXg6IHNkcE1MaW5lSW5kZXhcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5zb2NrZXQub24oJ2NhbGw6YW5zd2VyZWQnLCBkYXRhID0+IHtcbiAgICAgICAgICAgIHRoaXMud2VicnRjLmhhbmRsZUFuc3dlclJlY2VpdmVkKHtzZHA6IGRhdGEuc2RwLCB0eXBlOiBkYXRhLnR5cGV9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5zb2NrZXQub24oJ2NhbGw6YW5zd2VyJywgZGF0YSA9PiB7XG4gICAgICAgICAgICB0aGlzLmFuc3dlckNhbGwoe1xuICAgICAgICAgICAgICAgIHNkcDogZGF0YS5zZHAsXG4gICAgICAgICAgICAgICAgdHlwZTogZGF0YS50eXBlXG4gICAgICAgICAgICB9LCB7ZW5hYmxlVmlkZW86IHRydWUsIGVuYWJsZUF1ZGlvOiB0cnVlfSk7XG4gICAgICAgIH0pO1xuXG5cbiAgICB9XG5cbiAgICBpc0luaXRpYXRvcjogYm9vbGVhbjtcbiAgICBjYWxsRGF0YTogYW55O1xuXG4gICAgZ2V0VXNlcnMoKSB7XG4gICAgICAgIHRoaXMuc29ja2V0LmVtaXQoJ2dldFVzZXJzJywge30pO1xuICAgIH1cblxuICAgIGFuc3dlckNhbGwoc2RwOiBXZWJSVENTZHAsIG9wdGlvbnMpIHtcbiAgICAgICAgdGhpcy53ZWJydGMgPSBuZXcgV2ViUlRDKG9wdGlvbnMpO1xuXG4gICAgICAgIHRoaXMud2VicnRjLm9uKCd3ZWJSVENDbGllbnREaWRSZWNlaXZlUmVtb3RlVmlkZW9UcmFja1N0cmVhbScsIGFyZ3MgPT4ge1xuXG4gICAgICAgICAgICBjb25zdCBvYmplY3QgPSBhcmdzLm9iamVjdDtcbiAgICAgICAgICAgIGNvbnN0IHJlbW90ZVZpZGVvVHJhY2sgPSBvYmplY3QuZ2V0KCdyZW1vdGVWaWRlb1RyYWNrJyk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhyZW1vdGVWaWRlb1RyYWNrKTtcbiAgICAgICAgICAgIHRoaXMudmlkZW9UcmFjayA9IG9iamVjdC5nZXQoJ3JlbW90ZVZpZGVvVHJhY2snKTtcbiAgICAgICAgICAgIHRoaXMucmVtb3RlU3RyZWFtID0gb2JqZWN0LmdldCgnc3RyZWFtJyk7XG4gICAgICAgICAgICBjb25zdCB2aWRlbyA9IHRoaXMucmVtb3RlVmlkZW9WaWV3O1xuICAgICAgICAgICAgaWYgKHZpZGVvKSB7XG4gICAgICAgICAgICAgICAgdmlkZW8udmlkZW9UcmFjayA9IHJlbW90ZVZpZGVvVHJhY2s7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMud2VicnRjLm9uKCd3ZWJSVENDbGllbnRTdGFydENhbGxXaXRoU2RwJywgYXJncyA9PiB7XG4gICAgICAgICAgICBjb25zdCBzZHAgPSBhcmdzLm9iamVjdC5nZXQoJ3NkcCcpO1xuICAgICAgICAgICAgY29uc3QgdHlwZSA9IGFyZ3Mub2JqZWN0LmdldCgndHlwZScpO1xuICAgICAgICAgICAgaWYgKHR5cGUgPT09IFdlYlJUQ1NkcFR5cGUuQU5TV0VSKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zb2NrZXQuZW1pdCgnYW5zd2VyZWQnLCB7XG4gICAgICAgICAgICAgICAgICAgIGZyb206IHRoaXMuY3VycmVudFVzZXIsXG4gICAgICAgICAgICAgICAgICAgIHRvOiB0aGlzLm90aGVyLFxuICAgICAgICAgICAgICAgICAgICBzZHA6IHNkcCxcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogdHlwZVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLndlYnJ0Yy5vbignd2ViUlRDQ2xpZW50RGlkR2VuZXJhdGVJY2VDYW5kaWRhdGUnLCBhcmdzID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGljZUNhbmRpZGF0ZSA9IGFyZ3Mub2JqZWN0LmdldCgnaWNlQ2FuZGlkYXRlJykgYXMgV2ViUlRDSWNlQ2FuZGlkYXRlO1xuICAgICAgICAgICAgdGhpcy5zb2NrZXQuZW1pdCgnaWNlQ2FuZGlkYXRlJywgT2JqZWN0LmFzc2lnbih7dG86IHRoaXMub3RoZXIsIGZyb206IHRoaXMuY3VycmVudFVzZXJ9LCBpY2VDYW5kaWRhdGUpXG4gICAgICAgICAgICApO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmluaXRDYW1lcmEoKS50aGVuKHN0cmVhbSA9PiB7XG4gICAgICAgICAgICB0aGlzLmxvY2FsU3RyZWFtID0gc3RyZWFtO1xuICAgICAgICAgICAgdGhpcy5zZXRVcExvY2FsVmlldyh0cnVlKTtcbiAgICAgICAgICAgIHRoaXMud2VicnRjLmNvbm5lY3QoKTtcbiAgICAgICAgICAgIHRoaXMud2VicnRjLmFkZExvY2FsU3RyZWFtKHRoaXMubG9jYWxTdHJlYW0pO1xuICAgICAgICAgICAgdGhpcy53ZWJydGMuY3JlYXRlQW5zd2VyRm9yT2ZmZXJSZWNlaXZlZCh7XG4gICAgICAgICAgICAgICAgdHlwZTogc2RwLnR5cGUsXG4gICAgICAgICAgICAgICAgc2RwOiBzZHAuc2RwXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgYW5zd2VyKGZyb20sIHRvLCBzZHAsIHR5cGUpIHtcbiAgICAgICAgdGhpcy5vdGhlciA9IGZyb207XG4gICAgICAgIHRoaXMuYW5zd2VyQ2FsbCh7XG4gICAgICAgICAgICBzZHA6IHNkcCxcbiAgICAgICAgICAgIHR5cGU6IHR5cGVcbiAgICAgICAgfSwge2VuYWJsZVZpZGVvOiB0cnVlLCBlbmFibGVBdWRpbzogdHJ1ZX0pO1xuICAgIH1cblxuICAgIGNhbGwodXNlcm5hbWUsIG9wdGlvbnMpIHtcbiAgICAgICAgdGhpcy5vdGhlciA9IHVzZXJuYW1lO1xuXG4gICAgICAgIHRoaXMud2VicnRjID0gbmV3IFdlYlJUQyhvcHRpb25zKTtcblxuXG4gICAgICAgIHRoaXMud2VicnRjLm9uKCd3ZWJSVENDbGllbnREaWRSZWNlaXZlUmVtb3RlVmlkZW9UcmFja1N0cmVhbScsIGFyZ3MgPT4ge1xuICAgICAgICAgICAgY29uc3Qgb2JqZWN0ID0gYXJncy5vYmplY3Q7XG4gICAgICAgICAgICBjb25zdCByZW1vdGVWaWRlb1RyYWNrID0gb2JqZWN0LmdldCgncmVtb3RlVmlkZW9UcmFjaycpO1xuICAgICAgICAgICAgY29uc3QgdmlkZW8gPSB0aGlzLnJlbW90ZVZpZGVvVmlldztcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKHR5cGVvZiByZW1vdGVWaWRlb1RyYWNrKTtcblxuICAgICAgICAgICAgdGhpcy5yZW1vdGVTdHJlYW0gPSBvYmplY3QuZ2V0KCdzdHJlYW0nKTtcbiAgICAgICAgICAgIGlmICh2aWRlbykge1xuICAgICAgICAgICAgICAgIHZpZGVvLnZpZGVvVHJhY2sgPSByZW1vdGVWaWRlb1RyYWNrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuXG4gICAgICAgIHRoaXMud2VicnRjLm9uKCd3ZWJSVENDbGllbnRTdGFydENhbGxXaXRoU2RwJywgYXJncyA9PiB7XG4gICAgICAgICAgICBjb25zdCBzZHAgPSBhcmdzLm9iamVjdC5nZXQoJ3NkcCcpO1xuICAgICAgICAgICAgY29uc3QgdHlwZSA9IGFyZ3Mub2JqZWN0LmdldCgndHlwZScpO1xuICAgICAgICAgICAgaWYgKHR5cGUgPT09IFdlYlJUQ1NkcFR5cGUuQU5TV0VSKSB7XG4gICAgICAgICAgICAgICAgdGhpcy53ZWJydGMuaGFuZGxlQW5zd2VyUmVjZWl2ZWQoe1xuICAgICAgICAgICAgICAgICAgICBzZHA6IHNkcCxcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogdHlwZVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNvY2tldC5lbWl0KCdjYWxsJywge1xuICAgICAgICAgICAgICAgICAgICBmcm9tOiB0aGlzLmN1cnJlbnRVc2VyLFxuICAgICAgICAgICAgICAgICAgICB0bzogdXNlcm5hbWUsXG4gICAgICAgICAgICAgICAgICAgIHNkcDogc2RwLFxuICAgICAgICAgICAgICAgICAgICB0eXBlOiB0eXBlXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMud2VicnRjLm9uKCd3ZWJSVENDbGllbnREaWRHZW5lcmF0ZUljZUNhbmRpZGF0ZScsIGFyZ3MgPT4ge1xuICAgICAgICAgICAgY29uc3QgaWNlQ2FuZGlkYXRlID0gYXJncy5vYmplY3QuZ2V0KCdpY2VDYW5kaWRhdGUnKTtcbiAgICAgICAgICAgIHRoaXMuc29ja2V0LmVtaXQoXG4gICAgICAgICAgICAgICAgJ2ljZUNhbmRpZGF0ZScsXG4gICAgICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgdG86IHVzZXJuYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgZnJvbTogdGhpcy5jdXJyZW50VXNlclxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBpY2VDYW5kaWRhdGVcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICApO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmluaXRDYW1lcmEoKS50aGVuKHN0cmVhbSA9PiB7XG4gICAgICAgICAgICB0aGlzLmxvY2FsU3RyZWFtID0gc3RyZWFtO1xuICAgICAgICAgICAgdGhpcy5zZXRVcExvY2FsVmlldyh0cnVlKTtcbiAgICAgICAgICAgIHRoaXMud2VicnRjLmNvbm5lY3QoKTtcbiAgICAgICAgICAgIHRoaXMud2VicnRjLmFkZExvY2FsU3RyZWFtKHRoaXMubG9jYWxTdHJlYW0pO1xuICAgICAgICAgICAgdGhpcy53ZWJydGMubWFrZU9mZmVyKCk7XG4gICAgICAgIH0pO1xuXG4gICAgfVxuXG5cbiAgICBwcml2YXRlIGluaXRDYW1lcmEoKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgaWYgKFdlYlJUQy5oYXNQZXJtaXNzaW9ucygpKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy53ZWJydGMuZ2V0VXNlck1lZGlhKDEpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIGZyb20oV2ViUlRDLnJlcXVlc3RQZXJtaXNzaW9ucygpKVxuICAgICAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgICAgICBzd2l0Y2hNYXAoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFdlYlJUQy5oYXNQZXJtaXNzaW9ucygpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZyb20odGhpcy53ZWJydGMuZ2V0VXNlck1lZGlhKDEpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKCdIYXMgbm8gcGVybWlzc2lvbicpO1xuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAudG9Qcm9taXNlKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHNldFVwTG9jYWxWaWV3KG1pcnJvcikge1xuICAgICAgICBjb25zdCBsb2NhbFZpZGVvID0gdGhpcy5sb2NhbFZpZGVvVmlldztcbiAgICAgICAgbG9jYWxWaWRlby5taXJyb3IgPSB0cnVlO1xuICAgICAgICBsb2NhbFZpZGVvLnN0cmVhbSA9IHRoaXMubG9jYWxTdHJlYW07XG5cbiAgICB9XG5cblxuICAgIC8vIFBlcnNvbmFscyBmdW5jdGlvbnMuXG4gICAgY2hhbmdlTWljcm9waG9uZVN0YXRlKCkge1xuICAgICAgICB0aGlzLm1pY3JvcGhvbmVTdGF0ZSA9ICF0aGlzLm1pY3JvcGhvbmVTdGF0ZTtcblxuICAgICAgICByZXR1cm4gdGhpcy53ZWJydGMubWljRW5hYmxlZCghdGhpcy5taWNyb3Bob25lU3RhdGUpO1xuICAgIH1cblxuXG4gICAgc3RvcFZpZGVvKCkge1xuICAgICAgICBjb25zdCB2aWRlb1RyYWNrID0gdGhpcy5sb2NhbFN0cmVhbS52aWRlb1RyYWNrcy5nZXQoMCk7XG4gICAgICAgIGNvbnN0IHRyYWNrSWQgPSB2aWRlb1RyYWNrLmlkKCk7XG4gICAgICAgIHRoaXMudmlkZW9zdGF0ID0gIXRoaXMudmlkZW9zdGF0O1xuICAgICAgICB2aWRlb1RyYWNrLnNldEVuYWJsZWQodGhpcy52aWRlb3N0YXQpO1xuXG4gICAgfVxuXG5cbiAgICBzdG9wQ2FsbCgpIHtcblxuICAgICAgICB0aGlzLndlYnJ0Yy5kaXNjb25uZWN0KCk7XG4gICAgfVxuXG59XG4iXX0=